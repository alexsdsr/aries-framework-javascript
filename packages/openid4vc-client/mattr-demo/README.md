- [Overview](#overview)
- [VC issuance demo](#vc-issuance-demo)
  - [OpenID user's credentials](#openid-users-credentials)
  - [Prepare the code](#prepare-the-code)
  - [Patch the `CredentialRequestClient.js` in `sphereon` library](#patch-the-credentialrequestclientjs-in-sphereon-library)
  - [How to run the demo](#how-to-run-the-demo)
- [Issues](#issues)
  - [Credential Offer](#credential-offer)
  - [Authorization URL](#authorization-url)
    - [Request parameters generating issue](#request-parameters-generating-issue)
    - [`scope` parameter value](#scope-parameter-value)
  - [Credential Request](#credential-request)
    - [`types` field of Credential Request](#types-field-of-credential-request)
      - [`sphereon` issue](#sphereon-issue)
      - [`Mattr` issue](#mattr-issue)
    - [`proof` field of Credential Request](#proof-field-of-credential-request)
  - [VC validation error](#vc-validation-error)


# Overview

The `mattr-demo` script is implemented to show current state of compatibility between `AFJ` (as a wallet) and `Mattr` (as a VC issuer). The `Authorization flow` is used to issue VC. The code is base on the [PR#1474](https://github.com/hyperledger/aries-framework-javascript/pull/1474).

`sphereon` version: 0.7.0
`OID4VCI` protocol version: 1.0.11

# VC issuance demo

## OpenID user's credentials

[auth0](https://auth0.com) account is:

```
username: user@example.com
password: 6PeJH6R7627g
```

## Prepare the code

Clone the repo:

```
git clone git@github.com:alexsdsr/aries-framework-javascript.git
git checkout mattr-demo
```

Prepare the code:

```
cd aries-framework-javascript
yarn install
yarn build
cd packages/openid4vc-client
yarn build
```

## Patch the `CredentialRequestClient.js` in `sphereon` library

Updated the file as described (see below sections for details):

```
createCredentialRequest(opts) {
...
        return {
            // types,
            type: types[0],
            format,
            // proof,
        };
...
}
```

TODO: make automation for it

## How to run the demo

Demo of VCs issuance consists of three steps:

1. Authorization URL generating
2. Authorization via browser (Google Chrome is recommended)
3. Issuance of the VC

To run the full process run the command:

```
yarn mattr-demo
```

First step will be started. Once it is completed two values will be printed:

```
Auth URL: https://john-john-stzkbp.vii.au01.mattr.global/core/v1/oauth/authorize?response_type=code&client_id=mobilewallet&code_challenge_method=S256&code_challenge=1LIXmzf63OHAcEEGWj_-xkcf1haGdPDynkL9QfikNC0&redirect_uri=global.mattr.wallet://credentials/callback&scope=ldp_vc:TestCourseCredential

Code verifier: UbmqdRgnbyp8s38516TVBTyi4Ad38uzAZOh6D4ijnem
```

Copy `Auth URL` value and put it into Google Chrome ('console' tab of developer tools should be opened). Once authorization page is loaded put username and password and wait for the redirect link to appear on developer tools panel.
Copy the full link from your browser and paste it into terminal. Then copy the `Code verifier` value printed on the first step and put it into terminal as well.
After some time VC should be printed in terminal.

# Issues

## Credential Offer


According to the [OID4VCI protocol documentation](https://openid.net/specs/openid-4-verifiable-credential-issuance-1_0.html#name-credential-offer-parameters) the `grants` field is optional part of a credential offer. However the `sphereon` library doesn't support credential offers without the `grants` field. It returns the error message:

```
Flows Authorization Code Flow is not supported by issuer undefined

      at new OpenID4VCIClient (../../node_modules/@sphereon/oid4vci-client/lib/OpenID4VCIClient.ts:68:13)
      at Function.<anonymous> (../../node_modules/@sphereon/oid4vci-client/lib/OpenID4VCIClient.ts:94:20)
      at fulfilled (../../node_modules/@sphereon/oid4vci-client/dist/OpenID4VCIClient.js:5:58)
```

The credential offer generated by Mattr doesn't include the `grants` field:

```
openid-credential-offer://?credential_offer=%7B%22credential_issuer%22%3A%22https%3A%2F%2Fjohn-john-stzkbp.vii.au01.mattr.global%22%2C%22credentials%22%3A%5B%22969e5a08-ac5c-4304-8345-958236eed60d%22%5D%7D
```

decoded:

```
openid-credential-offer://?credential_offer={"credential_issuer":"https://john-john-stzkbp.vii.au01.mattr.global","credentials":["969e5a08-ac5c-4304-8345-958236eed60d"]}
```

In order to let `sphereon` continue the `Autorization code flow` it's required to add the `grants` field:

```
{
    ...
    "grants": {
        "authorization_code": {}
    }
}
```

The full credential offer is:

```
openid-credential-offer://?credential_offer=%7B%22credential_issuer%22%3A%22https%3A%2F%2Fjohn-john-stzkbp.vii.au01.mattr.global%22%2C%22credentials%22%3A%5B%22969e5a08-ac5c-4304-8345-958236eed60d%22%5D%2C%20%22grants%22%3A%20%7B%22authorization_code%22%3A%20%7B%7D%7D%7D
```

decoded:

```
openid-credential-offer://?credential_offer={"credential_issuer":"https://john-john-stzkbp.vii.au01.mattr.global","credentials":["969e5a08-ac5c-4304-8345-958236eed60d"], "grants": {"authorization_code": {}}}
```

## Authorization URL

### Request parameters generating issue

According to the [OID4VCI protocol documentation](https://openid.net/specs/openid-4-verifiable-credential-issuance-1_0.html#name-authorization-request) an authorization request must be a HTTP GET request containing set of GET-parameters. However the `sphereon v.0.7.0` library generates a set of request parameters in a json-encoded form in case `OID4VCI v.1.0.11`.
See the `convertJsonToURI` function [here](https://github.com/Sphereon-Opensource/OID4VCI/blob/v0.7.0/packages/common/lib/functions/Encoding.ts):

```
export function convertJsonToURI(
  json: ...
  opts?: EncodeJsonAsURIOpts,
): string {
...
  let components: string;
  if (opts?.version && opts.version > OpenId4VCIVersion.VER_1_0_08) {
    // v11 changed from encoding every param to a encoded json object with a credential_offer param key
    components = encodeAndStripWhitespace(JSON.stringify(json));
  } else {
...
  }
...
}
```

Such implementation doesn't look correct according to `OID4VCI v.1.0.11`. Moreover an authorization URL generated by `sphereon` is not acceptable by `Mattr`.

The `OID4VCI v.1.0.11` supports two ways to specify a credential type in an authorization request:

1. `scope` request parameter
2. `authorization_details` request parameter provided in a [form of url-encoded json-object](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-rar-23#section-2)

It means the protocol defines only the `authorization_details` request parameter (if it is used in particular request) in a json-form, not all the request parameters as it's implemented in `sphereon`.


The below code was implemented as a workaround to transform original json-encoded authorization URL to the form acceptable by `Mattr`:

```
//parse json-encoded URL into list of GET-parameters
const decodedAuthUrl = decodeURIComponent(authorizationUrl);
const jsonPosition = decodedAuthUrl.indexOf('{');
const reqParams = JSON.parse(decodedAuthUrl.substring(jsonPosition));

//replace the scope value 'openidldp_vc:TestCourseCredential' with 'ldp_vc:TestCourseCredential'
reqParams.scope = reqParams.scope.replace('openid', '');

const getParams = Object.entries(reqParams).map(kv => `${kv[0]}=${kv[1]}`).join('&');

const newAuthUrl = `${decodedAuthUrl.substring(0, jsonPosition)}${getParams}`;
```

Example of a valid authorization URL:

```
https://john-john-stzkbp.vii.au01.mattr.global/core/v1/oauth/authorize?response_type=code&client_id=mobilewallet&code_challenge_method=S256&code_challenge=kMFS-nNTptCsokYOxZfsaUr6nWgtws2EDtM-QOtP-mc&redirect_uri=global.mattr.wallet://credentials/callback&scope=ldp_vc:TestCourseCredential
```


### `scope` parameter value

The `sphereon` library generates the `openidldp_vc:TestCourseCredential` value for the `scope` authorization request parameter. But this value is not accepted by `Mattr`. `Mattr` expects for the `ldp_vc:TestCourseCredential` value.
In order to make the request acceptable by `Mattr` the value of `scope` changed as shown in the above code.


## Credential Request

### `types` field of Credential Request

According to the [OID4VCI protocol documentation](https://openid.net/specs/openid-4-verifiable-credential-issuance-1_0.html#name-credential-request) a credential request must provide the `types` field as a part of json-encoded HTTP POST body. This field must be a json-encoded array of the credential types.
There are two issue with it:

1. The `sphereon` library puts the list of credential ids instead of credential types as it defined in the documentation
2. `Mattr` doesn't accept the `types` field

#### `sphereon` issue

The `types` value must include a list of credential types (it is not well-defined in documentation) resolved from credential ids (provided in credential offer). But for some reason `sphereon` doesn't resolve credential ids into credential types under the hood.
In order to make `sphereon` put credential types into `types` field of credential request the below code is changed in the `src/OpenId4VcClientService.ts` file:

```
const credentialResponse = await credentialRequestClient.acquireCredentialsUsingProof({
  proofInput,
  //hardcoded (only for demo purposes) explicit declaration of credential types to be issued
  credentialTypes: ['TestCourseCredential'],
  format: credentialFormat,
})
```

#### `Mattr` issue

`Mattr` doesn't accept the `types` field. The error message is:

```
{
    code: 'BadRequest',
    message: 'Validation Error',
    details: [
        {
            msg: 'must provide either "type" or "credential_definition"',
            param: 'credential_definition',
            location: 'body'
        }
    ]
}
```

The below changes is implemented in the `node_modules/@sphereon/oid4vci-client/dist/CredentialRequestClient.js` file as a workaround for demo purposes:

```
createCredentialRequest(opts) {
...
        return {
            // types,
            type: types[0],
            format,
            // proof,
        };
...
}
```

There are two changes:
- the `types` field replaced with `type` (as `Mattr` suggests in the above error-message)
- the `proof` field is removed from request (see details below)


### `proof` field of Credential Request

For some reason `Mattr` doesn't accept a proof of possession provided by `sphereon` as a part of credential request.
Mattr returns an error message:

```
`invalid_or_missing_proof`
```

This issue requires additional research. Since the `proof` is optional field it is removed from credential request for demo purposes (see the code above).

## VC validation error

Example of the VC issued by `Mattr`:

```
    {
      credential: {
        type: [
          'VerifiableCredential',
          'TestCourseCredential',
          'AlumniCredential',
          'EducationCredential'
        ],
        issuer: {
          id: 'did:key:z6MkikUm8bnWSrpVVZiZJpynGKMRhnsEbb7hZNvvQ8LFgyuu',
          name: 'TEST ABC University',
          logoUrl: 'https://example.edu/img/logo.png',
          iconUrl: 'https://example.edu/img/icon.png'
        },
        name: 'MATTR TEST Course credential',
        description: 'This credential shows that the person has attended a course.',
        credentialBranding: {
          backgroundColor: '#B00AA0',
          watermarkImageUrl: 'https://example.edu/img/watermark.png'
        },
        issuanceDate: '2023-09-15T14:10:44.589Z',
        credentialSubject: { email: 'testing@gmail.com', lastName: 'Idea', firstName: 'No' },
        '@context': [
          'https://www.w3.org/2018/credentials/v1',
          'https://w3id.org/vc-revocation-list-2020/v1',
          'https://mattr.global/contexts/vc-extensions/v2'
        ],
        credentialStatus: {
          id: 'https://john-john-stzkbp.vii.au01.mattr.global/core/v1/revocation-lists/0bf7d461-9dea-4c23-b6f7-6d5b91c7d3c2#1',
          type: 'RevocationList2020Status',
          revocationListIndex: '1',
          revocationListCredential: 'https://john-john-stzkbp.vii.au01.mattr.global/core/v1/revocation-lists/0bf7d461-9dea-4c23-b6f7-6d5b91c7d3c2'
        },
        proof: {
          type: 'Ed25519Signature2018',
          created: '2023-09-15T14:10:44Z',
          verificationMethod: 'did:key:z6MkikUm8bnWSrpVVZiZJpynGKMRhnsEbb7hZNvvQ8LFgyuu#z6MkikUm8bnWSrpVVZiZJpynGKMRhnsEbb7hZNvvQ8LFgyuu',
          proofPurpose: 'assertionMethod',
          jws: 'eyJhbGciOiJFZERTQSIsImI2NCI6ZmFsc2UsImNyaXQiOlsiYjY0Il19..Dcfub0TWFztHNphApznRJa22n3rHVHnjQkUl6IF4qaYUyF-cVx6CYz7E942vsbn82Rb2BCLusAHZOj7GhCmdBg'
        }
      },
      format: 'ldp_vc'
    }
```

For some reason `AFJ` (in fact, the libraries used under the hood) can't validate VCs issued by `Mattr`. Error message is:

```
AriesFrameworkError: Failed to validate credential, error = VerificationError: Verification error(s).

      477 |
      478 |     if (!result || !result.isValid) {
    > 479 |       throw new AriesFrameworkError(`Failed to validate credential, error = ${result.error}`)
          |             ^
      480 |     }
      481 |
      482 |     const storedCredential = await this.w3cCredentialService.storeCredential(agentContext, {

      at OpenId4VcClientService.handleCredentialResponse (src/OpenId4VcClientService.ts:479:13)
      at async OpenId4VcClientService.requestCredential (src/OpenId4VcClientService.ts:261:32)
      at async Object.<anonymous> (tests/mattr_issue_vc.test.ts:141:36)
```

`AFJ` can't store VCs as well. Error message is:

```
jsonld.InvalidUrl: Dereferencing a URL did not result in a valid JSON-LD object. Possible causes are an inaccessible URL perhaps due to a same-origin policy (ensure the server uses CORS if you are using client-side JavaScript), too many redirects, a non-JSON response, or more than one HTTP Link Header was provided for a remote context.

      332 |     // Get the expanded types
      333 |     const expandedTypes: SingleOrArray<string> = (
    > 334 |       await jsonld.expand(JsonTransformer.toJSON(credential), {
          |       ^
      335 |         documentLoader: this.w3cCredentialsModuleConfig.documentLoader(agentContext),
      336 |       })
      337 |     )[0]['@type']

      at ContextResolver._fetchContext (../../node_modules/@digitalcredentials/jsonld/lib/ContextResolver.js:173:13)
      at async ContextResolver._resolveRemoteContext (../../node_modules/@digitalcredentials/jsonld/lib/ContextResolver.js:117:34)
      at async ContextResolver.resolve (../../node_modules/@digitalcredentials/jsonld/lib/ContextResolver.js:50:22)
      at async Object.<anonymous>.api.process (../../node_modules/@digitalcredentials/jsonld/lib/context.js:65:20)
      at async Object.<anonymous>.api.expand (../../node_modules/@digitalcredentials/jsonld/lib/expand.js:215:17)
      at async Function.jsonld.expand (../../node_modules/@digitalcredentials/jsonld/lib/jsonld.js:325:18)
      at async W3cJsonLdCredentialService.getExpandedTypesForCredential (../core/src/modules/vc/data-integrity/W3cJsonLdCredentialService.ts:334:7)
      at async W3cCredentialService.storeCredential (../core/src/modules/vc/W3cCredentialService.ts:167:23)
      at async OpenId4VcClientService.handleCredentialResponse (src/OpenId4VcClientService.ts:484:30)
      at async OpenId4VcClientService.requestCredential (src/OpenId4VcClientService.ts:261:32)
      at async Object.<anonymous> (tests/mattr_issue_vc.test.ts:141:36)
```

Short debug of this issue didn't bring any result. Additional research is required.
